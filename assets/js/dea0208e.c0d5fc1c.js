"use strict";(self.webpackChunkapp_docs=self.webpackChunkapp_docs||[]).push([[3870],{151:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/11-09-endpoint-created-5d3756404984323b407779e1bf39ec82.png"},559:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/11-02-create-form-85857d390339f4065c4e088469db4621.png"},913:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/11-04-add-files-ae0b67c5532418fc15f3b82cfadede2b.png"},5268:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/11-08-initializing-ca70c090ecea0035f42eb3801132d43c.png"},5577:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/11-12-nvm-service-details-903df8ea90cbd9866d321cbdfd467021.png"},6196:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/11-07-advanced-config-228dc1abd38fd509b114cbe33ef37a8c.png"},6575:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/11-06-new-endpoint-form-3e6caea1014d0f82250f985d1f4d0f06.png"},6778:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/11-10-endpoint-settings-0440252e8be6ef4cd4ae30ff8ccb5893.png"},7080:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/11-03-Files-534b42fb523eb99f075acd6b273e0941.png"},7381:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/11-05-endpoints-334930175eed4cd4819ef5416f5cb467.png"},8187:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/11-11-creating-service-nvm-bb823bf62c2948dac647551d8f48840a.png"},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>r});var i=t(6540);const o={},s=i.createContext(o);function a(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),i.createElement(s.Provider,{value:n},e.children)}},8671:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"tutorials/ai/huggingface","title":"How to create and integrate a Hugging Face Inference Endpoint","description":"How to create and integrate a Hugging Face Inference Endpoint","source":"@site/docs/tutorials/ai/11-huggingface.md","sourceDirName":"tutorials/ai","slug":"/tutorials/ai/huggingface","permalink":"/docs/tutorials/ai/huggingface","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":11,"frontMatter":{"sidebar_position":11,"description":"How to create and integrate a Hugging Face Inference Endpoint"},"sidebar":"tutorialSidebar","previous":{"title":"Monetizing a ChatGPT plugin using Nevermined","permalink":"/docs/tutorials/ai/chatgpt-plugin"},"next":{"title":"Overview","permalink":"/docs/protocol/"}}');var o=t(4848),s=t(8453);const a={sidebar_position:11,description:"How to create and integrate a Hugging Face Inference Endpoint"},r="How to create and integrate a Hugging Face Inference Endpoint",d={},c=[{value:"Requirements",id:"requirements",level:2},{value:"Deploy a Hugging Face model",id:"deploy-a-hugging-face-model",level:2},{value:"Implement and deploy your own AI Model",id:"implement-and-deploy-your-own-ai-model",level:2},{value:"Create a new Model repository",id:"create-a-new-model-repository",level:3},{value:"Implementing a simple example with Haystack",id:"implementing-a-simple-example-with-haystack",level:3},{value:"Expose the custom Model as Inference Endpoint",id:"expose-the-custom-model-as-inference-endpoint",level:3},{value:"Testing the Inference Endpoint",id:"testing-the-inference-endpoint",level:3},{value:"Publish the Inference Endpoint in Nevermined",id:"publish-the-inference-endpoint-in-nevermined",level:2},{value:"Before you register your Service",id:"before-you-register-your-service",level:3},{value:"Registering the AI Model",id:"registering-the-ai-model",level:3},{value:"Access to the details of the Service",id:"access-to-the-details-of-the-service",level:3},{value:"Consuming your AI Model",id:"consuming-your-ai-model",level:3},{value:"Examples",id:"examples",level:4}];function l(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"how-to-create-and-integrate-a-hugging-face-inference-endpoint",children:"How to create and integrate a Hugging Face Inference Endpoint"})}),"\n",(0,o.jsx)(n.p,{children:"Hugging Face is one of the most, if not the most important Open Source Communities, in the scope of Machine Learning and AI technologies."}),"\n",(0,o.jsx)(n.p,{children:"It is not only a huge hub of models, datasets, and transformers, but also an environment where users can deploy, test, and productize AI models or pipelines."}),"\n",(0,o.jsx)(n.p,{children:"Hugging Face allows users to implement and deploy models, transformers, pipelines, etc, in two different ways:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"https://huggingface.co/docs/hub/spaces",children:"Spaces"})," Based on Github repos, users can implement their models here and deploy it as an app for free (it's also possible to pay for additional resources). This kind of deployment is for demo/fast development purposes, so it is not ready for production."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"https://huggingface.co/docs/inference-endpoints/index",children:"Inference Endpoints"}),". With Inference Endpoints a user or organization is able to deploy a model into production in a cloud provider in a completely transparent way. Hugging Face will take care of deploying the necessary containers, securitization, auto scaling, etc."]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"In this tutorial we will show you how to deploy your models and pipelines as Inference Endpoints, and how to publish them in Nevermined App, so you can safely share and monetize your AI model."}),"\n",(0,o.jsx)(n.h2,{id:"requirements",children:"Requirements"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["A Hugging Face ",(0,o.jsx)(n.a,{href:"https://huggingface.co/join",children:"Account"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"https://huggingface.co/settings/billing",children:"Payment Method added"}),". Inference Endpoints are not free. We will show you how to keep the cost pretty low so you can test it without spending too much money."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"https://huggingface.co/docs/hub/security-tokens#how-to-manage-user-access-tokens",children:"Generate a token"})," for your account with Read permissions."]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"deploy-a-hugging-face-model",children:"Deploy a Hugging Face model"}),"\n",(0,o.jsxs)(n.p,{children:["You can deploy any model available in Hugging Face Hub in a really straightforward way. This ",(0,o.jsx)(n.a,{href:"https://huggingface.co/docs/inference-endpoints/guides/create_endpoint",children:"document"})," from Hugging Face's documentation shows how to deploy a model from a repository."]}),"\n",(0,o.jsx)(n.p,{children:"In this tutorial we want to show you how to implement and deploy a more complex scenario, where you are not deploying an already built model, but a more elaborated process."}),"\n",(0,o.jsx)(n.h2,{id:"implement-and-deploy-your-own-ai-model",children:"Implement and deploy your own AI Model"}),"\n",(0,o.jsx)(n.p,{children:"Through the next sections you will learn how to implement a custom AI model or process, deploy it as an Inference Endpoint and publish it in Nevermined App."}),"\n",(0,o.jsx)(n.h3,{id:"create-a-new-model-repository",children:"Create a new Model repository"}),"\n",(0,o.jsxs)(n.p,{children:["In order to implement a custom model you have to create a new model repository. You can work locally in your implementation and use git to create and synchronize in Hugging Face, as it's explained in ",(0,o.jsx)(n.a,{href:"https://huggingface.co/docs/inference-endpoints/guides/custom_handler",children:"Hugging Face Documentation"}),". In this document you will find different examples of custom models."]}),"\n",(0,o.jsx)(n.p,{children:"Also you can manually create this model repository and add/edit the files using the UI. For the sake of simplicity we are doing this in this tutorial."}),"\n",(0,o.jsxs)(n.p,{children:["To create this repository you just need to use the button ",(0,o.jsx)(n.em,{children:"New"})," you can find in the main page of your Hugging Face profile (or your organization profile)"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Create a new Model option",src:t(8699).A+"",width:"941",height:"300"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Create a new Model formulary",src:t(559).A+"",width:"1096",height:"811"})}),"\n",(0,o.jsxs)(n.p,{children:["Once the model repository is created you can use the ",(0,o.jsx)(n.em,{children:"Add"})," button to create and commit new files in the repository. Also you have the possibility to edit the files as many times as you need."]}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.img,{alt:"Create a new Model files",src:t(7080).A+"",width:"1143",height:"519"}),"\n",(0,o.jsx)(n.img,{alt:"Create a new Model add files",src:t(913).A+"",width:"1052",height:"230"})]}),"\n",(0,o.jsx)(n.p,{children:"You will typically need a handler.py and a requirements.txt file."}),"\n",(0,o.jsx)(n.p,{children:"Of course creating and editing the files directly in the repo is not the best way to implement your custom model because there is no way to test it before deploying the model as an Inference Endpoint."}),"\n",(0,o.jsx)(n.h3,{id:"implementing-a-simple-example-with-haystack",children:"Implementing a simple example with Haystack"}),"\n",(0,o.jsx)(n.p,{children:'As we mentioned, in the Hugging Face documentation you can find multiple examples about how to expose your own model using custom Inference Endpoints. For our example we will take a different approach, to show you that there are more possibilities than "just" use a model.'}),"\n",(0,o.jsxs)(n.p,{children:["In this case we are going to use ",(0,o.jsx)(n.a,{href:"https://haystack.deepset.ai",children:"Haystack"})," to build an InMemory store where we will index a document related to DeSci DAOs, and using ",(0,o.jsx)(n.a,{href:"https://huggingface.co/deepset/roberta-base-squad2-distilled",children:"roberta-base-squad2-distilled"})," we can implement a Q&A service using the documents stored."]}),"\n",(0,o.jsx)(n.p,{children:"The first step is to add the needed dependencies using the requirements.txt file:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-txt",children:"farm-haystack==1.19.0\nfarm-haystack[inference]==1.19.0\nvalidators==0.21.1\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Next we need to implement an EndpointHandler class in a handler.py file. This class will contain two methods, ",(0,o.jsx)(n.strong,{children:"init"}),", where we will place all the code that will be executed when the endpoint is starting (so it will be executed only once), and ",(0,o.jsx)(n.strong,{children:"call"}),", that handles the execution calls."]}),"\n",(0,o.jsxs)(n.p,{children:["In the ",(0,o.jsx)(n.strong,{children:"init"})," method we will place all the code to initialize Haystack and to read and index the file with the DeSci DAOs information. In the ",(0,o.jsx)(n.strong,{children:"call"})," method we read the payload of the call to get the question, and we call the Haystack pipeline to get an answer."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-py",children:'import os\nfrom haystack.utils import fetch_archive_from_http, clean_wiki_text, convert_files_to_docs\nfrom haystack.schema import Answer\nfrom haystack.document_stores import InMemoryDocumentStore\nfrom haystack.pipelines import ExtractiveQAPipeline\nfrom haystack.nodes import FARMReader, TfidfRetriever\nimport logging\nimport json\n\nos.environ[\'TOKENIZERS_PARALLELISM\'] ="false"\n\n#Haystack Components\ndef start_haystack():\n    document_store = InMemoryDocumentStore()\n    load_and_write_data(document_store)\n    retriever = TfidfRetriever(document_store=document_store)\n    reader = FARMReader(model_name_or_path="deepset/roberta-base-squad2-distilled", use_gpu=True)\n    pipeline = ExtractiveQAPipeline(reader, retriever)\n    return pipeline\n\ndef load_and_write_data(document_store):\n    \n    # Get the absolute path of the script\n    script_path = os.path.realpath(__file__)\n    # Get the script directory\n    script_dir = os.path.dirname(script_path)\n    doc_dir = script_dir + "/dao_data"\n    print("Loading data ...")\n\n    docs = convert_files_to_docs(dir_path=doc_dir, clean_func=clean_wiki_text, split_paragraphs=True)\n    document_store.write_documents(docs)\n\n\nclass EndpointHandler():\n    def __init__(self, path=""):\n        # load the optimized model     \n        self.pipeline = start_haystack()\n\n    def __call__(self, data):\n        \n        inputs = data.pop("inputs", None)\n        question = inputs.pop("question", None)\n        if question is not None:\n            prediction = self.pipeline.run(query=question, params={"Retriever": {"top_k": 10}, "Reader": {"top_k": 5}})\n        else:\n            return {}\n        \n        # postprocess the prediction\n        response = { "answer": prediction[\'answers\'][0].answer}\n        return json.dumps(response)\n'})}),"\n",(0,o.jsx)(n.p,{children:"And that's it. We can now deploy this process as an Inference Endpoint. But remember, in a real scenario you should implement and test your model/process in your local environment to check that everything works correctly."}),"\n",(0,o.jsx)(n.h3,{id:"expose-the-custom-model-as-inference-endpoint",children:"Expose the custom Model as Inference Endpoint"}),"\n",(0,o.jsx)(n.p,{children:"The next step is to publish your model as an Inference Endpoint. Remember, you need to add a Payment Method to be able to use this Hugging Face's capability."}),"\n",(0,o.jsxs)(n.p,{children:["You can access Inference Endpoints ",(0,o.jsx)(n.a,{href:"https://ui.endpoints.huggingface.co/",children:"here"}),". In the main screen you can see the endpoints you have already deployed, and a ",(0,o.jsx)(n.em,{children:"New endpoint"})," button to create a new one."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Inference Endpoints",src:t(7381).A+"",width:"1235",height:"410"})}),"\n",(0,o.jsx)(n.p,{children:"In the New Endpoint form, you have to introduce the name of the repository where you have implemented your model. Also you need to choose the Cloud Provider (you can leave the default one)."}),"\n",(0,o.jsx)(n.p,{children:"You can pick a small Instance type, instead of the medium one, to keep the cost low (You can see the estimated cost per hour at the bottom of the screen). Take into account that this also implies that the execution time will be longer."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Create new Inference Endpoint",src:t(6575).A+"",width:"910",height:"957"})}),"\n",(0,o.jsxs)(n.p,{children:["In the ",(0,o.jsx)(n.em,{children:"Advanced Configuration"})," section you can find some useful configuration. For instance, you can enable the ",(0,o.jsx)(n.em,{children:"Automatic Scale-to-Zero"})," option so the endpoint will be effectively paused where there is no activity (You can pause and resume your endpoint manually as well). The time the endpoint is paused won't be billed."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Advanced Configuration",src:t(6196).A+"",width:"910",height:"730"})}),"\n",(0,o.jsxs)(n.p,{children:["Once you finish setting all the configuration, click on the ",(0,o.jsx)(n.em,{children:"Create Endpoint"})," button, and the Inference Endpoint will be initialized.\n",(0,o.jsx)(n.img,{alt:"Inference Endpoint Initializing",src:t(5268).A+"",width:"1226",height:"582"})]}),"\n",(0,o.jsx)(n.p,{children:"After a few minutes you will see your Inference Endpoint running and the screen will show you the URL where it is located."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Inference Endpoint Created",src:t(151).A+"",width:"1191",height:"569"})}),"\n",(0,o.jsxs)(n.p,{children:["In the ",(0,o.jsx)(n.em,{children:"Settings"})," menu you can change the configuration of the Inference Endpoint, or update it to the latest version in your repository."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Inference Endpoint Settings",src:t(6778).A+"",width:"1224",height:"779"})}),"\n",(0,o.jsx)(n.h3,{id:"testing-the-inference-endpoint",children:"Testing the Inference Endpoint"}),"\n",(0,o.jsx)(n.p,{children:"To test the Inference Endpoint you just need the URL and your Read Token."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'export HF_TOKEN="api_orgweRt....srbCQpQ"\n\ncurl https://clmdl67ebofnkfxk.eu-west-1.aws.endpoints.huggingface.cloud \\\n-X POST \\\n-d \'{"inputs":{"question":"What is VitaDAO?"}}\' \\\n-H "Authorization: Bearer $HF_TOKEN" \\\n-H "Content-Type: application/json"\n'})}),"\n",(0,o.jsxs)(n.p,{children:["If the execution of the endpoint takes around (or over) a minute, we recommend you change the settings of the Instance Type, for instance from ",(0,o.jsx)(n.em,{children:"small"})," to ",(0,o.jsx)(n.em,{children:"medium"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"If you have deployed the Inference endpoint under an organization, any user who belongs to the organization will be able to access the endpoint using their own Read Tokens."}),"\n",(0,o.jsx)(n.h2,{id:"publish-the-inference-endpoint-in-nevermined",children:"Publish the Inference Endpoint in Nevermined"}),"\n",(0,o.jsx)(n.p,{children:"Once you have implemented, deployed, and protected your own AI model or pipeline in Hugging Face, you can share it with the Community in a safe way, and even monetize it, if you want, using a Nevermined Pricing Plan."}),"\n",(0,o.jsx)(n.p,{children:"In order to test and learn how you can use Nevermined App, we provide a testing environment where you can try the different features provided by Nevermined."}),"\n",(0,o.jsxs)(n.p,{children:["You can access this test version of Nevermined App ",(0,o.jsx)(n.a,{href:"https://testing.nevermined.app/en",children:"here"})]}),"\n",(0,o.jsx)(n.h3,{id:"before-you-register-your-service",children:"Before you register your Service"}),"\n",(0,o.jsxs)(n.p,{children:["We recommend you take a look at the different ",(0,o.jsx)(n.a,{href:"../../getting-started/",children:"guides and tutorials we have about Nevermined App"})]}),"\n",(0,o.jsxs)(n.p,{children:["The next step is to create a brand new ",(0,o.jsx)(n.a,{href:"../builders/create-plan",children:"Pricing Plan"})]}),"\n",(0,o.jsxs)(n.p,{children:["You will register your AI Service associated with this Subscription you are about to create. The process to create a new Subscription is pretty straightforward, but ",(0,o.jsx)(n.a,{href:"../builders/create-plan",children:"here"})," you can find some help to guide you."]}),"\n",(0,o.jsx)(n.h3,{id:"registering-the-ai-model",children:"Registering the AI Model"}),"\n",(0,o.jsx)(n.p,{children:"So now that you have all set up and you have created a Pricing Plan, you can create a Web Service Agent to register your AI Model in Nevermined App."}),"\n",(0,o.jsxs)(n.p,{children:["You can find a complete guide to register your service ",(0,o.jsx)(n.a,{href:"../builders/register-agent/",children:"here"})]}),"\n",(0,o.jsxs)(n.p,{children:["In the ",(0,o.jsx)(n.em,{children:"details"})," step you need to add the endpoint. As the Inference Endpoint does not generate any OpenAPI document, we need to do it manually."]}),"\n",(0,o.jsxs)(n.p,{children:["Add the Inference Endpoint URL as a ",(0,o.jsx)(n.em,{children:"HTTP POST"})," Protected Method."]}),"\n",(0,o.jsxs)(n.p,{children:["Select ",(0,o.jsx)(n.em,{children:"Bearer Token"})," and add a Hugging Face Token with Read Permissions. This token will be sent and stored encrypted, so no one will be able to access it."]}),"\n",(0,o.jsxs)(n.p,{children:["Make sure you provide enough information about your service in the ",(0,o.jsx)(n.em,{children:"Description"})," and ",(0,o.jsx)(n.em,{children:"Integration"})," fields to allow the user to understand the purpose of your service and how they can use it."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Register service in Nevermined",src:t(8187).A+"",width:"1087",height:"734"})}),"\n",(0,o.jsx)(n.h3,{id:"access-to-the-details-of-the-service",children:"Access to the details of the Service"}),"\n",(0,o.jsx)(n.p,{children:'When the process is finished, you will be able to access the details of your new Service Agent (you can also access anytime using the "My Agents" menu on the App).\nIn the Service details you can access the description of the endpoints.'}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Service details in Nevermined",src:t(5577).A+"",width:"1217",height:"748"})}),"\n",(0,o.jsx)(n.h3,{id:"consuming-your-ai-model",children:"Consuming your AI Model"}),"\n",(0,o.jsxs)(n.p,{children:["Every user that has purchased your Subscription will be able to use your AI Model through Nevermined. In this ",(0,o.jsx)(n.a,{href:"../integration/agent-integration/",children:"guide"})," you can find how users can integrate your service."]}),"\n",(0,o.jsx)(n.h4,{id:"examples",children:"Examples"}),"\n",(0,o.jsx)(n.p,{children:"Using the service through Nevermined Proxy URL is really straightforward. You need to use the Proxy URL instead of the actual URL of your service, adding the specific endpoint you want to call and the parameters defined in that endpoint, and include the Authorization Header with the JWT."}),"\n",(0,o.jsx)(n.p,{children:"For instance:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'export NVM_TOKEN="eyJhbGciOiJkaXIiLCJlbmMiOiJBMTI4Q0JDLUhTMjU2In0..EW-BsszuYJLLuBylm6VPvw.zlGJQcCRjjG_m....srbCQpQ"\n\ncurl -H "Authorization: $NVM_TOKEN" -X POST "https://3dqf53c6wn5sd5crq1n0bzh92cr09kaevh16io0pbefn57kbcj.proxy.testing.nevermined.app"  \\\n--header \'content-type: application/json\' \\\n--data \'{"inputs":{"question":"What is VitaDAO?"}}\'\n'})})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},8699:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/11-01-create-model-a77898bc83dc8c246841a3fb1d827960.png"}}]);